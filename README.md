# SOPS secrets manager using Nix

## Update sops file

Add the wanted keys to the `secrets.yaml` file
and then then run the following command to encrypt the data.

```sh
sops updatekeys secrets.yaml
```

And commit + push to the private repo

## Update flake

```sh
nix flake lock --update-input secrets
```

## Hangup on home-manager switch

1. Try a refresh command:

```sh
home-manager switch --refresh --flake .#mirza
```

2. Use `systemctl` to reload failed services:

```sh
systemctl --user reset-failed
```

## Keys

Add these keys to `.sops.yaml`.

### Standalone

Create a standalone key for the user to be used.
Reference it in the `users` section after creating it.

```sh
mkdir -p ~/.config/sops/age
age-keygen -o ~/.config/sops/age/keys.txt
```

### Host Key

Create an `age` key from the hosts SSH key found in `/etc/ssh`.
Please use the ed25519 key or something stronger in the future :)
Add the key to the `hosts` sections.

```sh
# Default key generated by sshd
cat /etc/ssh/ssh_host_ed25519_key.pub | ssh-to-age
# Key generated using TPM module
cat /etc/ssh/ssh_tpm_host_ecdsa_key.pub | ssh-to-age
```

# Yubikey

## u2f

To add a key for a new user,
use `pamu2fcfg` and put it in `.config/Yubico/u2f_keys` (or in the secrets.yaml file).

For adding new keys to an existing user,
use the following shell command to combine the string:

```sh
echo "$(cat .config/Yubico/u2f_keys)$(pamu2fcfg -n)"
```

## SSH

To generate a new key, we need to have the yubikey pluged in,
and use a special key type `ed25519-sk` (sk stands for security key, I guess?):

```sh
ssh-keygen -t ed25519-sk -N "" -C "<nice comment>" -f ~/.ssh/id_<name>
```

This will generate both the public and private keys on the device.
We can also generate the private key on the device,
so we do not need to store the a file on the PC
(from [this](https://xeiaso.net/blog/yubikey-ssh-key-storage/) guide):

```sh
ssh-keygen -t ed25519-sk -O resident
```

(The private key needs-to/can be deleted afterwards)
